<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>MyScript JS</title>

<script type="text/javascript" src="../../js/prism.js" > </script> 
<link href="../../css/MySBuilder.css" rel="stylesheet" type="text/css">
<link rel="shortcut icon" href="../../images/favicon.ico" />

</head>

<body bgcolor="#FFFFFF" text="#000000">
<h1>MyScript JS Developer Guide</h1>
<p><img src="../../images/ic-music.png" style="float:right" width="80" height="80"></p>
<h2>Music recognition</h2>
<p>MyScript Music recognition engine analyzes the spatial relationship between the various parts of the music document.</p>
<p style="text-align:center"><img src="../../images/music_reco.png"></p>
<p>The recognizer will send you a result in MusicXML or ScoreTREE strings.</p>
<h3>Making a music recognition request</h3>
<p>The below example shows a text recognition request where the following  are to be specified:
  </li>
</p>
<ul>
  <ul>
    <li>URL (defined by default)</li>
    <li>application key &amp; HMAC key (obtained in the <a href="http://cloud.myscript.com" target="_blank">MyScript Cloud Admin UI</a>)</li>
  </ul>
</ul>
<p class="remark">A clef is required for each recognition, as this is inherent to the recognition engine.</p>
<pre class=language-javascript><code>&lt;script&gt;
    var result = document.getElementById("music-result");
    var canvas = document.getElementById("music-canvas");
    var context = canvas.getContext("2d");
    var pointerId;

    var url = 'http://cloud.myscript.com/api/v3.0/recognition/rest';
    var applicationKey = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx';
    var hmacKey = 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx';

    var stroker = new MyScript.Stroker();
    var musicRenderer = new MyScript.MusicRenderer();
    var musicRecognizer = new MyScript.MusicRecognizer(url);
    var instanceId;

    // Required staff and clef to allow music recognition

    var staff = new MyScript.MusicStaff();
    staff.setCount(5);
    staff.setTop(100);
    staff.setGap(20);

    musicRecognizer.getParameters().setResultTypes(['MUSICXML']);
    musicRecognizer.getParameters().setDivisions(480);
    musicRecognizer.getParameters().setStaff(staff);



    var clef = new MyScript.MusicClefInput();
    clef.setSymbol('G');
    clef.setOctave(0);
    clef.setYAnchor(staff.getTop() + (staff.getGap() * (staff.getCount() - 2)));

    var boundingBox = new MyScript.Rectangle();
    boundingBox.setX(5);
    boundingBox.setY(73);
    boundingBox.setHeight((staff.getCount() + 2) * staff.getGap());

    var clefInput = new MyScript.MusicClefInputComponent();
    clefInput.setValue(clef);
    clefInput.setBoundingBox(boundingBox);

    var components = [clefInput];

    musicRenderer.drawStaff(staff, context);
    musicRenderer.drawComponents(components, context);

    function doRecognition () {
        musicRecognizer.doSimpleRecognition(applicationKey, instanceId, components.concat(stroker.getStrokes()), hmacKey).then(
                function (data) {
                    if (!instanceId) {
                        instanceId = data.getInstanceId();
                    } else if (instanceId !== data.getInstanceId()) {
                        return;
                    }
                    var results = data.getMusicDocument().getResultElements();
                    for (var i in results) {
                        if (results[i] instanceof MyScript.MusicXMLResultElement) {
                            result.innerText = results[i].getValue();
                        }
                    }
                }
        )
    }

    function onPointerDown (event, x, y) {
        musicRenderer.drawStart(event, x, y);
        stroker.startStrokeWriting(x, y);
    }

    function onPointerMove (event, x, y) {
        musicRenderer.drawContinue(event, x, y, context);
        stroker.continueStrokeWriting(x, y);
    }

    function onPointerUp (event, x, y) {
        musicRenderer.drawEnd(event, x, y, context);
        stroker.endStrokeWriting(event);
        if (!stroker.isEmpty()) {
            doRecognition();
        }
    }

    /**
     * Firefox missing offsetX and offsetY properties hack
     * @param event
     * @returns {{x: number, y: number}}
     */
    function getOffset (event) {

        var element = event.target;
        var offset = {x: 0, y: 0};

        while (element.offsetParent) {
            offset.x += element.offsetLeft;
            offset.y += element.offsetTop;
            element = element.offsetParent;
        }

        offset.x = event.pageX - offset.x;
        offset.y = event.pageY - offset.y;

        return offset;
    }

    function getX (event) {
        if (event.offsetX) {
            return event.offsetX;
        }
        return getOffset(event).x;
    }

    function getY (event) {
        if (event.offsetY) {
            return event.offsetY;
        }
        return getOffset(event).y;
    }

    canvas.addEventListener('mousedown', function (event) {
        if (!pointerId) {
            pointerId = event.pointerId;
            onPointerDown(event, getX(event), getY(event));
        }
    }, false);

    canvas.addEventListener('mousemove', function (event) {
        if (pointerId === event.pointerId) {
            onPointerMove(event, getX(event), getY(event));
        }
    }, false);

    canvas.addEventListener('mouseup', function (event) {
        if (pointerId === event.pointerId) {
            onPointerUp(event, getX(event), getY(event));
            pointerId = undefined;
        }
    }, false);

    canvas.addEventListener('mouseleave', function (event) {
        if (pointerId === event.pointerId) {
            onPointerUp(event, getX(event), getY(event));
            pointerId = undefined;
        }
    }, false);
&lt;/script&gt;</code></pre>
<p>See the <a>reference guide</a> for information on the mandatory and optional parameters needed for music recognition.</p>
<h3>How does music recognition work?</h3>
<p style="text-align:center;"><img src="../../images/music_workflow.png"></td>
</p>
<p>MyScript Music requires two resource files:</p>
<ul><ul>
  <li><strong>Music Alphabet Knowledge</strong><br>
    This is a special resource used for recognition of music elements, providing &ldquo;music alphabet knowledge&rdquo; to the recognizer so it is able to recognize the various elements that could possibly make up a music score.
    </p>
  <li><strong>Music Grammar Knowledge</strong><br>
  The way the score elements can be recognized together is specified by this&nbsp;grammar&nbsp;resource that is attached to the recognizer.  
</ul></ul>
<p>Resources are to be attached to the recognizer, in order to tell it how to perform the segmentation of all the input ink parts.</p>
<p>While digital ink is captured in real time, it is simultaneously recognized in the background. The music recognizer will first analyze the spatial relationship between the parts of the score. It will then use a symbol classifier that calculates the probabilities for all the elements in the suggested segmentation. Finally it will output a result.</p>
<p></p>
</body>
</html>
